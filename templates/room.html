<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Video Stream</title>
</head>
<body>

    <h1>Live Video Stream</h1>

    <!-- Video element to display the live stream -->
    <video id="liveVideo" width="640" height="480" controls autoplay></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js" defer></script>
    <script>
        window.addEventListener('load', () => {
            const socket = io('ws://localhost:3000');
            let peerConnection;

            // Listen for messages of type 'stream' to start the live video
            socket.on('message', async (message) => {
                if (message.type === 'stream') {
                    const roomName = message.room;
                    const liveVideo = document.getElementById('liveVideo');

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        liveVideo.srcObject = stream;

                        // Create a peer connection
                        peerConnection = new RTCPeerConnection();

                        // Add local stream to the peer connection
                        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

                        // Handle incoming tracks from the remote peer
                        peerConnection.ontrack = (event) => {
                            liveVideo.srcObject = event.streams[0];
                        };

                        // Send SDP offer to the remote peer
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);

                        socket.emit('message', { type: 'offer', offer, room: roomName });
                    } catch (error) {
                        console.error('Error accessing media devices:', error);
                    }
                } else if (message.type === 'answer') {
                    // Handle SDP answer from the remote peer
                    const answer = new RTCSessionDescription(message.answer);
                    await peerConnection.setRemoteDescription(answer);
                }
            });
        });
    </script>
    
</body>
</html>
